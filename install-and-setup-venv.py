#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
One Command Virtual Environment Setup Script
T·ª± ƒë·ªông ph√°t hi·ªán Python command v√† thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng ·∫£o ho√†n ch·ªânh
Author: ariescasino
Date: 2025-09-16 03:13:19
"""

import os
import sys
import subprocess
import platform
import shutil
from pathlib import Path
import json

class VenvSetupTool:
    def __init__(self):
        self.system = platform.system().lower()
        self.venv_name = "myproject_env"
        self.project_dir = Path.cwd()
        self.venv_dir = self.project_dir / self.venv_name
        
        # Common packages to install
        self.default_packages = [
            "pip", "setuptools", "wheel",
            "requests", "beautifulsoup4", "lxml",
            "flask", "fastapi",
            "numpy", "pandas",
            "pytest", "black",
            "python-dotenv", "pyyaml"
        ]
        
    def log(self, message, level="INFO"):
        """Log v·ªõi timestamp v√† m√†u s·∫Øc"""
        import datetime
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        colors = {
            "INFO": "\033[92m",     # Green
            "WARN": "\033[93m",     # Yellow  
            "ERROR": "\033[91m",    # Red
            "RESET": "\033[0m"      # Reset
        }
        color = colors.get(level, colors["RESET"])
        print(f"{color}[{timestamp}] [{level}] {message}{colors['RESET']}")
        
    def run_command(self, command, check=True, shell=True):
        """Ch·∫°y l·ªánh h·ªá th·ªëng v·ªõi error handling"""
        self.log(f"Executing: {command}")
        try:
            result = subprocess.run(
                command, 
                shell=shell, 
                check=check, 
                capture_output=True, 
                text=True
            )
            if result.stdout:
                print(result.stdout.strip())
            return result
        except subprocess.CalledProcessError as e:
            self.log(f"Command failed: {e}", "ERROR")
            if e.stderr:
                print(e.stderr.strip())
            return None
            
    def find_python_command(self):
        """T·ª± ƒë·ªông t√¨m Python command c√≥ s·∫µn"""
        self.log("ƒêang t√¨m Python command...")
        
        # Danh s√°ch c√°c Python command c√≥ th·ªÉ c√≥
        python_commands = ["python3", "python", "py", "python3.11", "python3.10", "python3.9"]
        
        for cmd in python_commands:
            try:
                result = subprocess.run([cmd, "--version"], capture_output=True, text=True, timeout=10)
                if result.returncode == 0:
                    version = result.stdout.strip()
                    self.log(f"‚úÖ T√¨m th·∫•y Python: {cmd} -> {version}")
                    return cmd
            except (FileNotFoundError, subprocess.TimeoutExpired):
                continue
                
        # N·∫øu kh√¥ng t√¨m th·∫•y, th·ª≠ c√†i ƒë·∫∑t
        return self.install_python()
        
    def install_python(self):
        """C√†i ƒë·∫∑t Python d·ª±a tr√™n h·ªá ƒëi·ªÅu h√†nh"""
        self.log("Python ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t, ti·∫øn h√†nh c√†i ƒë·∫∑t...")
        
        if self.system == "linux":
            return self.install_python_linux()
        elif self.system == "darwin":  # macOS
            return self.install_python_macos()
        elif self.system == "windows":
            return self.install_python_windows()
        else:
            self.log(f"H·ªá ƒëi·ªÅu h√†nh kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£: {self.system}", "ERROR")
            return None
            
    def install_python_linux(self):
        """C√†i ƒë·∫∑t Python tr√™n Linux"""
        self.log("C√†i ƒë·∫∑t Python tr√™n Linux...")
        
        # Ph√°t hi·ªán Linux distribution
        if shutil.which("apt"):
            # Ubuntu/Debian
            commands = [
                "sudo apt update",
                "sudo apt install -y python3 python3-pip python3-venv python3-dev",
                "sudo apt install -y build-essential libssl-dev libffi-dev"
            ]
        elif shutil.which("yum"):
            # CentOS/RHEL
            commands = [
                "sudo yum update -y",
                "sudo yum install -y python3 python3-pip python3-venv python3-devel"
            ]
        elif shutil.which("dnf"):
            # Fedora
            commands = [
                "sudo dnf update -y", 
                "sudo dnf install -y python3 python3-pip python3-venv python3-devel"
            ]
        elif shutil.which("pacman"):
            # Arch Linux
            commands = [
                "sudo pacman -Sy python python-pip"
            ]
        else:
            self.log("Kh√¥ng nh·∫≠n d·∫°ng ƒë∆∞·ª£c Linux distribution", "ERROR")
            return None
            
        for cmd in commands:
            result = self.run_command(cmd, check=False)
            if result is None:
                self.log(f"L·ªói khi ch·∫°y: {cmd}", "WARN")
                
        return "python3"
        
    def install_python_macos(self):
        """C√†i ƒë·∫∑t Python tr√™n macOS"""
        self.log("C√†i ƒë·∫∑t Python tr√™n macOS...")
        
        # Ki·ªÉm tra Homebrew
        if shutil.which("brew"):
            self.run_command("brew install python@3.11")
        else:
            # C√†i ƒë·∫∑t Homebrew tr∆∞·ªõc
            self.log("C√†i ƒë·∫∑t Homebrew...")
            homebrew_install = '/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
            self.run_command(homebrew_install)
            self.run_command("brew install python@3.11")
            
        return "python3"
        
    def install_python_windows(self):
        """C√†i ƒë·∫∑t Python tr√™n Windows"""
        self.log("C√†i ƒë·∫∑t Python tr√™n Windows...")
        self.log("Vui l√≤ng t·∫£i v√† c√†i ƒë·∫∑t Python t·ª´: https://www.python.org/downloads/", "WARN")
        self.log("Ho·∫∑c s·ª≠ d·ª•ng winget: winget install Python.Python.3.11", "INFO")
        return "python"
        
    def create_virtual_environment(self, python_cmd):
        """T·∫°o m√¥i tr∆∞·ªùng ·∫£o"""
        self.log(f"T·∫°o m√¥i tr∆∞·ªùng ·∫£o: {self.venv_name}")
        
        # X√≥a m√¥i tr∆∞·ªùng ·∫£o c≈© n·∫øu t·ªìn t·∫°i
        if self.venv_dir.exists():
            self.log("X√≥a m√¥i tr∆∞·ªùng ·∫£o c≈©...")
            shutil.rmtree(self.venv_dir)
            
        # T·∫°o m√¥i tr∆∞·ªùng ·∫£o m·ªõi
        create_cmd = f"{python_cmd} -m venv {self.venv_dir}"
        result = self.run_command(create_cmd)
        
        if result and result.returncode == 0:
            self.log("‚úÖ M√¥i tr∆∞·ªùng ·∫£o ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!")
            return True
        else:
            self.log("‚ùå L·ªói t·∫°o m√¥i tr∆∞·ªùng ·∫£o", "ERROR")
            return False
            
    def get_python_executable(self):
        """L·∫•y ƒë∆∞·ªùng d·∫´n Python executable trong venv"""
        if self.system == "windows":
            return self.venv_dir / "Scripts" / "python.exe"
        else:
            return self.venv_dir / "bin" / "python"
            
    def get_activation_script(self):
        """L·∫•y script k√≠ch ho·∫°t m√¥i tr∆∞·ªùng ·∫£o"""
        if self.system == "windows":
            return self.venv_dir / "Scripts" / "activate.bat"
        else:
            return self.venv_dir / "bin" / "activate"
            
    def install_packages(self):
        """C√†i ƒë·∫∑t packages c·∫ßn thi·∫øt"""
        self.log("C√†i ƒë·∫∑t packages...")
        
        python_exe = self.get_python_executable()
        
        # Upgrade pip tr∆∞·ªõc
        upgrade_pip = f"{python_exe} -m pip install --upgrade pip"
        self.run_command(upgrade_pip)
        
        # C√†i ƒë·∫∑t t·ª´ng package
        for package in self.default_packages:
            install_cmd = f"{python_exe} -m pip install {package}"
            self.log(f"C√†i ƒë·∫∑t {package}...")
            result = self.run_command(install_cmd, check=False)
            if result and result.returncode == 0:
                self.log(f"‚úÖ {package} ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t")
            else:
                self.log(f"‚ö†Ô∏è  L·ªói c√†i ƒë·∫∑t {package}", "WARN")
                
    def create_activation_script(self):
        """T·∫°o script k√≠ch ho·∫°t d·ªÖ s·ª≠ d·ª•ng"""
        self.log("T·∫°o activation scripts...")
        
        if self.system == "windows":
            script_content = f"""@echo off
echo Activating Python Virtual Environment: {self.venv_name}
call "{self.get_activation_script()}"
echo ‚úÖ Environment activated! Python path: %VIRTUAL_ENV%
echo üí° Type 'deactivate' to exit the environment
cmd /k
"""
            script_path = self.project_dir / "activate_venv.bat"
        else:
            script_content = f"""#!/bin/bash
echo "üöÄ Activating Python Virtual Environment: {self.venv_name}"
source "{self.get_activation_script()}"
echo "‚úÖ Environment activated! Python path: $VIRTUAL_ENV"
echo "üí° Type 'deactivate' to exit the environment"
exec bash --rcfile <(echo '. ~/.bashrc; PS1="({self.venv_name}) $PS1"')
"""
            script_path = self.project_dir / "activate_venv.sh"
            
        with open(script_path, 'w') as f:
            f.write(script_content)
            
        # Make executable on Unix systems
        if self.system != "windows":
            os.chmod(script_path, 0o755)
            
        self.log(f"‚úÖ Activation script created: {script_path}")
        return script_path
        
    def create_project_structure(self):
        """T·∫°o c·∫•u tr√∫c project"""
        self.log("T·∫°o c·∫•u tr√∫c project...")
        
        directories = ["src", "tests", "docs", "scripts", "data", "logs"]
        
        for dir_name in directories:
            dir_path = self.project_dir / dir_name
            dir_path.mkdir(exist_ok=True)
            
            if dir_name in ["src", "tests"]:
                init_file = dir_path / "__init__.py"
                init_file.touch()
                
        # T·∫°o main.py
        main_py_content = '''#!/usr/bin/env python3
"""
Main application entry point
"""

def main():
    print("üéâ Hello from your new Python project!")
    print("‚úÖ Virtual environment is working correctly!")
    
    # Test imports
    try:
        import requests
        print("‚úÖ requests module imported successfully")
    except ImportError:
        print("‚ùå requests module not found")
        
    try:
        import bs4
        print("‚úÖ beautifulsoup4 module imported successfully")
    except ImportError:
        print("‚ùå beautifulsoup4 module not found")

if __name__ == "__main__":
    main()
'''
        
        main_py_path = self.project_dir / "main.py"
        with open(main_py_path, 'w') as f:
            f.write(main_py_content)
            
        self.log("‚úÖ Project structure created!")
        
    def create_requirements_file(self):
        """T·∫°o requirements.txt"""
        self.log("T·∫°o requirements.txt...")
        
        python_exe = self.get_python_executable()
        freeze_cmd = f"{python_exe} -m pip freeze"
        
        result = self.run_command(freeze_cmd)
        if result:
            requirements_path = self.project_dir / "requirements.txt"
            with open(requirements_path, 'w') as f:
                f.write(result.stdout)
            self.log(f"‚úÖ Requirements file created: {requirements_path}")
            
    def test_installation(self):
        """Test m√¥i tr∆∞·ªùng ·∫£o"""
        self.log("Testing virtual environment...")
        
        python_exe = self.get_python_executable()
        
        # Test Python
        test_cmd = f"{python_exe} --version"
        result = self.run_command(test_cmd)
        
        if result and result.returncode == 0:
            self.log("‚úÖ Python test passed")
        else:
            self.log("‚ùå Python test failed", "ERROR")
            return False
            
        # Test main.py
        main_test_cmd = f"{python_exe} main.py"
        result = self.run_command(main_test_cmd)
        
        if result and result.returncode == 0:
            self.log("‚úÖ Main.py test passed")
        else:
            self.log("‚ùå Main.py test failed", "ERROR")
            
        return True
        
    def show_completion_info(self, activation_script):
        """Hi·ªÉn th·ªã th√¥ng tin ho√†n th√†nh"""
        separator = "=" * 70
        
        completion_info = f"""
{separator}
üéâ PYTHON VIRTUAL ENVIRONMENT SETUP COMPLETED! üéâ
{separator}

üìÅ Project Directory: {self.project_dir}
üêç Virtual Environment: {self.venv_name}
üì¶ Packages Installed: {len(self.default_packages)} packages

üöÄ QUICK START:

1. üî• Activate Environment:
   {activation_script}

2. ‚ñ∂Ô∏è  Run Application:
   python main.py

3. üì¶ Install More Packages:
   pip install package_name

4. üîå Deactivate Environment:
   deactivate

üìÇ FILES CREATED:
‚úÖ Virtual environment: {self.venv_name}/
‚úÖ Main script: main.py
‚úÖ Requirements: requirements.txt
‚úÖ Project structure: src/, tests/, docs/, scripts/, data/, logs/
‚úÖ Activation script: {activation_script.name}

üîß USEFUL COMMANDS:
‚Ä¢ pip list                         # List installed packages
‚Ä¢ pip freeze > requirements.txt    # Update requirements
‚Ä¢ pip install -r requirements.txt  # Install from requirements

üåü Your Python development environment is ready! üåü

{separator}
"""
        print(completion_info)
        
    def run_setup(self):
        """Ch·∫°y to√†n b·ªô qu√° tr√¨nh setup"""
        try:
            import datetime
            
            print("""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                ONE COMMAND PYTHON VENV SETUP TOOL                ‚ïë
‚ïë                       by ariescasino                             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            """)
            
            self.log("üöÄ B·∫Øt ƒë·∫ßu setup m√¥i tr∆∞·ªùng Python...")
            
            # 1. T√¨m Python command
            python_cmd = self.find_python_command()
            if not python_cmd:
                self.log("‚ùå Kh√¥ng th·ªÉ t√¨m th·∫•y ho·∫∑c c√†i ƒë·∫∑t Python", "ERROR")
                return False
                
            # 2. T·∫°o virtual environment
            if not self.create_virtual_environment(python_cmd):
                return False
                
            # 3. C√†i ƒë·∫∑t packages
            self.install_packages()
            
            # 4. T·∫°o project files
            self.create_project_structure()
            self.create_requirements_file()
            
            # 5. T·∫°o activation script
            activation_script = self.create_activation_script()
            
            # 6. Test installation
            self.test_installation()
                
            # 7. Hi·ªÉn th·ªã th√¥ng tin ho√†n th√†nh
            self.show_completion_info(activation_script)
            
            self.log("‚úÖ Setup ho√†n t·∫•t th√†nh c√¥ng!")
            return True
            
        except KeyboardInterrupt:
            self.log("‚ùå Setup b·ªã h·ªßy b·ªüi ng∆∞·ªùi d√πng", "WARN")
            return False
        except Exception as e:
            self.log(f"‚ùå L·ªói trong qu√° tr√¨nh setup: {str(e)}", "ERROR")
            import traceback
            traceback.print_exc()
            return False

def main():
    """Main function - Entry point"""
    import argparse
    
    parser = argparse.ArgumentParser(description='One command Python virtual environment setup')
    parser.add_argument('--name', '-n', default='myproject_env', help='Virtual environment name')
    parser.add_argument('--packages', '-p', nargs='*', help='Additional packages to install')
    
    args = parser.parse_args()
    
    setup_tool = VenvSetupTool()
    setup_tool.venv_name = args.name
    setup_tool.venv_dir = setup_tool.project_dir / setup_tool.venv_name
    
    if args.packages:
        setup_tool.default_packages.extend(args.packages)
        
    # Run setup
    success = setup_tool.run_setup()
    
    if success:
        print("\nüéâ Success! Your Python environment is ready to use!")
        sys.exit(0)
    else:
        print("\n‚ùå Setup failed. Please check the error messages above.")
        sys.exit(1)

if __name__ == "__main__":
    main()